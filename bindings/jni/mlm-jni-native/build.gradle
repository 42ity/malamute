/*
################################################################################
#  THIS FILE IS 100% GENERATED BY ZPROJECT; DO NOT EDIT EXCEPT EXPERIMENTALLY  #
#  Read the zproject/README.md for information about making permanent changes. #
################################################################################
*/

dependencies {
    compile project(':mlm-jni')
    runtimeOnly "org.zeromq.czmq:czmq-jni-${osdetector.classifier}:latest.release"
}

//  ------------------------------------------------------------------
//  Build section

task copyLibs(type: Copy) {
    def libraryPaths = System.getProperty('java.library.path').split(File.pathSeparator).toList()
    libraryPaths.add('/usr/local/lib')
    if (osdetector.os == 'windows') {
        libraryPaths.add("${rootDir}/mlm-jni/build/Release")
    } else {
        libraryPaths.add("${rootDir}/mlm-jni/build")
    }
    if (project.hasProperty('buildPrefix')) {
        if (osdetector.os == 'windows') {
            // DLLs are installed to the bin directory by cmake
            libraryPaths.add("${project.buildPrefix}/bin")
        }
        libraryPaths.add("${project.buildPrefix}/lib")
    }

    libraryPaths.each { path ->
        from path
            include 'libmlmjni.so'
            include 'libmlmjni.dylib'
            include '*mlmjni*.dll'
            include 'libmlm.so'
            include 'libmlm.dylib'
            include '*mlm*.dll'
            include 'libzmq.so'
            include 'libzmq.dylib'
            include '*zmq*.dll'
            include 'libczmq.so'
            include 'libczmq.dylib'
            include '*czmq*.dll'
        into 'build/natives'
    }
}

jar.baseName = "mlm-jni-${osdetector.classifier}"
jar.dependsOn copyLibs

jar {
    def arch = osdetector.arch.contains('64') ? '64' : '32'
    from 'build/natives'
        include '*'
    into "natives/${osdetector.os}_${arch}"
}

//  ------------------------------------------------------------------
//  Install and Publish section

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            artifactId = "malamute-jni-${osdetector.classifier}"
            pom {
                name = "malamute-jni-${osdetector.classifier}"
                description = 'ZeroMQ Message Broker'
                packaging = 'jar'
                url = 'https://github.com/zeromq/malamute'
                licenses {
                    license {
                        name = 'Mozilla Public License Version 2.0'
                        url = 'https://www.mozilla.org/en-US/MPL/2.0/'
                    }
                }
                scm {
                    connection = 'https://github.com/zeromq/malamute.git'
                    developerConnection = 'https://github.com/zeromq/malamute.git'
                    url = 'https://github.com/zeromq/malamute'
                }
            }
        }
    }
}

artifactoryPublish {
    publications ('mavenJava')
}

bintray {
    user = System.getenv('BINTRAY_USER')
    key = System.getenv('BINTRAY_KEY')
    publications = ['mavenJava']
    publish = true
    override = true
    pkg {
        repo = 'maven'
        name = "malamute-jni-${osdetector.classifier}"
        desc = 'ZeroMQ Message Broker'
        userOrg = System.getenv('BINTRAY_USER_ORG')
        licenses = ['MPL-2.0']
        websiteUrl = 'https://github.com/zeromq/malamute'
        issueTrackerUrl = 'https://github.com/zeromq/malamute/issues'
        vcsUrl = 'https://github.com/zeromq/malamute.git'
        githubRepo = System.getenv('BINTRAY_USER_ORG') + '/malamute'
        version {
            name = project.version
            vcsTag= project.version
        }
    }
}

//  ------------------------------------------------------------------
//  Cleanup section

clean.doFirst {
    delete fileTree(projectDir) {
        include '*.so'
        include '*.dylib'
    }
}
